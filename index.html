<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DIGITAL MARKSHEET</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    @page { size: A5; margin: 10mm; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f0f0f0; }
    .login-box { background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .login-box h2 { margin-bottom: 20px; }
    .login-box input { display: block; margin-bottom: 15px; width: 100%; padding: 8px; }
    .container { display: none; width: 100%; max-width: 595px; margin: auto; background-color: white; padding: 20px; border-radius: 10px; color: black; }
    #subjectFields { display: grid; grid-template-columns: 150px 80px 80px 80px 80px; align-items: center; gap: 10px; margin-top: 20px; }
    .button-row { margin-top: 40px; text-align: center; }
    .signature-row { display: flex; justify-content: space-between; align-items: center; margin-top: 40px; font-weight: bold; }
    .signature-block { position: relative; text-align: center; width: 180px; height: 180px; margin-left: 80px; }
    .signature-block img.signature { max-height: 50px; width: auto; position: absolute; top: 35px; left: 50%; transform: translateX(-50%); z-index: 1; }
    .signature-block .principal-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2em; font-weight: bold; color: #000; z-index: 2; }
    .school-title { display: flex; align-items: center; justify-content: flex-start; margin-bottom: 10px; }
    .school-title img { max-height: 80px; margin-right: 20px; }
    .exam-header { display:flex; align-items:center; gap:10px; margin: 10px 0 20px; }
    .examNameDisplay { border:none; font-weight:bold; background:transparent; pointer-events:none; width: 260px; }
    @media print {
      button, input[type="submit"] { display: none; }
      body { padding: 0; margin: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .container { width: 100%; margin: 0; }
    }
    .hidden { display: none !important; }
  </style>
</head>
<body background="https://res.cloudinary.com/dwfheimtj/image/upload/v1756303108/TT_bmf1u6.png">
  <div class="login-container" id="loginBox">
    <div class="login-box">
      <h2>Login</h2>
      <input type="text" id="username" placeholder="Username" />
      <input type="password" id="password" placeholder="Password" />
      <button id="loginBtn">Login</button>
      <p id="loginError" style="color: red; display: none;">Invalid Username or Password</p>
    </div>
  </div>

  <div class="container" id="mainContent"></div>

  <script>
    // ===================== AUTH =====================
    function authenticate() {
      const user = document.getElementById("username").value;
      const pass = document.getElementById("password").value;
      if (user === "CHSS" && pass === "CHSS1974") {
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        loadMarksheet();
      } else {
        document.getElementById("loginError").style.display = "block";
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('loginBtn').addEventListener('click', authenticate);
    });

    // ===================== BOOT =====================
    function loadMarksheet() {
      document.getElementById("mainContent").innerHTML = getCommonLayout();
      initSubjects();
      initRollNos();
      wireExamHandlers();
      updateExamTextDisplays();
    }

    // ===================== LAYOUT SWITCHER =====================
    function handleExamTypeChange() {
      const select = document.getElementById("examType");
      if (!select) return;
      const selectedText = select.options[select.selectedIndex]?.text || '';

      if (selectedText === "Weekly Test") {
        document.getElementById("mainContent").innerHTML = getWeeklyTestLayout();
        initRollNos();
        initWeeklyTest();
      } else if (selectedText === "Hr.Sec Examination") {
        document.getElementById("mainContent").innerHTML = getHrSecLayout();
        initRollNos();
        initHrSec();
      } else if (selectedText === "Phase-II Assessment") {
        document.getElementById("mainContent").innerHTML = PhaseIILayout();
        initRollNos();
      } else {
        document.getElementById("mainContent").innerHTML = getCommonLayout();
        initSubjects();
        initRollNos();
      }
      // Re-wire events after DOM replacement
      wireExamHandlers();
      // Restore the selected exam in the new dropdown (match by text)
      const newSelect = document.getElementById('examType');
      if (newSelect) {
        Array.from(newSelect.options).forEach(opt => {
          if (opt.text === selectedText) opt.selected = true;
        });
      }
      updateExamTextDisplays();
    }

    function buttonsHTML() {
      return `
        <div class="button-row">
          <hr>
          <button type="button" onclick="downloadAsImage()">Download</button>
          <button type="button" onclick="saveData()">Save Data</button>
          <button type="button" onclick="window.print()">Print</button>
          <button type="reset">Reset</button>
        </div>`;
    }

    // ===================== LAYOUTS =====================
    function headerHTML() {
      return `
        <div class="school-title">
          <img src="https://res.cloudinary.com/dwfheimtj/image/upload/v1749614028/SSSSSSSSSSSSSS_yrbkds.png" alt="School Logo" />
          <div>
            <h3 style="margin:0">CHANDMARI HIGHER SECONDARY SCHOOL</h3>
            <div class="exam-header">
              <label>Examination</label>
              <select id="examType" required>
                <option value="">Select Examination</option>
                <option>Weekly Test</option>
                <option>Mid Term</option>
                <option>1st Assessment</option>
                <option>2nd Assessment</option>
                <option>Model Examination</option>
                <option>Final Examination</option>
                <option>Phase-II Assessment</option>
                <option>Hr.Sec Examination</option>
              </select>
              <input type="text" class="examNameDisplay" id="examNameBox" readonly placeholder="Selected exam will appear here" />
            </div>
          </div>
        </div>`;
    }

    function signatureHTML() {
      return `
        <div class="signature-row">
          <div>Class Teacher</div>
          <div class="signature-block">
            <img src="https://res.cloudinary.com/dwfheimtj/image/upload/v1750691317/SIGNATURE1_sxs2ss.jpg" class="signature" alt="Digital Signature" />
            <div class="principal-label">Principal</div>
          </div>
        </div>`;
    }

    function getCommonLayout() {
      return `
        ${headerHTML()}
        <form id="markForm">
          <label for="studentName">Name</label>
          <input type="text" id="studentName" name="studentName" placeholder="Student Name" required />

          <label for="studentClass">Class</label>
          <select id="studentClass" name="studentClass" required>
            <option value="">Class</option>
            <option>LKG</option>
            <option>UKG</option>
            <option>1</option>
            <option>2</option>
            <option>3</option>
            <option>4</option>
            <option>5</option>
            <option>6</option>
            <option>7</option>
            <option>8</option>
            <option>9</option>
            <option>10</option>
            <option>11</option>
            <option>12</option>
          </select>

          <label for="studentSec">Section</label>
          <select id="studentSec" name="studentSec" required>
            <option value="">Sec</option>
            <option>A</option>
            <option>B</option>
            <option>C</option>
            <option>D</option>
          </select>

          <label for="rollNo">RollNo</label>
          <select id="rollNo" name="rollNo" required></select>

          <div id="subjectFields"></div>

          <label>Total Marks</label><br>
          <input type="number" id="overallTotal" name="overallTotal" placeholder="Total Marks" readonly /><br>
          <label>Average Marks</label><br>
          <input type="number" id="averageMarks" name="averageMarks" placeholder="Average Marks" readonly /><br>

          <label for="comments">Comments</label><br>
          <textarea id="comments" name="comments" placeholder="Enter comments here..." rows="3" style="width:100%;"></textarea><br>

<BR>
NWD &nbsp;&nbsp;<input type="text" name="NWD" SIZE=3> &nbsp;&nbsp;Attendence &nbsp;&nbsp;<input type="text" name="attendance" SIZE=3><BR>
<BR>
Result <select name="result">
<option value=""></option>
<option value="Promoted">Promoted</option>
<option value="Fail">Fail</option>
<option value="Pass">Pass</option>
<option value="Needs Improvement">Needs Improvement</option>
<option value="Passed under Consideration">Passed under Consideration</option>
<option value="Passed with TC">Passed with TC</option>
</select>


          ${signatureHTML()}
          ${buttonsHTML()}
        </form>`;
    }

    function getWeeklyTestLayout() {
      return `
        ${headerHTML()}
        <form id="weeklyForm">
          <label for="studentName">Name</label>
          <input type="text" id="studentName" name="studentName" placeholder="Student Name" required />

          <label for="studentClass">Class</label>
          <select id="studentClass" name="studentClass" required>
            <option value="">Class</option>
            <option>LKG</option>
            <option>UKG</option>
            <option>1</option>
            <option>2</option>
            <option>3</option>
            <option>4</option>
            <option>5</option>
            <option>6</option>
            <option>7</option>
            <option>8</option>
            <option>9</option>
            <option>10</option>
          </select>

          <label for="studentSec">Section</label>
          <select id="studentSec" name="studentSec" required>
            <option value="">Sec</option>
            <option>A</option>
            <option>B</option>
            <option>C</option>
            <option>D</option>
          </select>

          <label for="rollNo">RollNo</label>
          <select id="rollNo" name="rollNo" required></select>

          <table id="weeklyTestTable" border="1" cellspacing="0" cellpadding="5" style="width:100%; text-align:center; border-collapse:collapse; margin-top:20px;">
            <tr>
              <th>Subject</th>
              <th>Total Marks</th>
            </tr>
            ${['English','Maths','Science','Alt / Hindi','Grammar','Social Science','Moral Values','Heritage','GK','Computer / EE / FIT / BK'].map((s,i) => `
              <tr><td align="left">${s}</td><td><input type="number" name="weekly_${i}" class="weeklyMark" min="0" max="100"></td></tr>
            `).join('')}
            <tr><th align="left">Total Marks</th><td><input type="text" id="weeklyTotal" name="weeklyTotal" readonly></td></tr>
            <tr><th align="left">Average Marks</th><td><input type="text" id="weeklyAverage" name="weeklyAverage" readonly></td></tr>
            <tr><th align="left">Remarks</th><td><input type="text" size="30" id="weeklyComments" name="weeklyComments"></td></tr>
          </table>

          ${signatureHTML()}
          ${buttonsHTML()}
        </form>`;
    }

    function getHrSecLayout() {
      return `
        ${headerHTML()}
        <form id="hrSecForm">
          <label for="studentName">Name</label>
          <input type="text" id="studentName" name="studentName" placeholder="Student Name" required />

          <label for="studentClass">Class</label>
          <select id="studentClass" name="studentClass" required>
            <option value="">Class</option>
            <option>11</option>
            <option>12</option>
          </select>

          <label for="studentSec">Section</label>
          <select id="studentSec" name="studentSec" required>
            <option value="">Sec</option>
            <option>A</option>
            <option>B</option>
            <option>C</option>
            <option>D</option>
          </select>

          <label for="rollNo">RollNo</label>
          <select id="rollNo" name="rollNo" required></select>

          <!-- Academic Subjects Table -->
          <h3 style="margin-top:20px;"></h3>
          <table id="hrSecTable" border="1" cellspacing="0" cellpadding="5" 
            style="width:100%; text-align:center; border-collapse:collapse; margin-top:10px;">
            <tr>
              <th>Subject</th>
              <th>Ext</th>
              <th>Int</th>
              <th>Total</th>
            </tr>
            ${["English","Alt/Tenyidie","History","Pol.Sc","Sociology","Eco/Edu"].map((sub,i) => `
              <tr>
                <td align="left">${sub}</td>
                <td><input type="number" name="hrExt_${i}" class="hrExt" min="0" max="100"></td>
                <td><input type="number" name="hrInt_${i}" class="hrInt" min="0" max="100"></td>
                <td><input type="text" name="hrTotal_${i}" class="hrTotal" readonly></td>
              </tr>`).join('')}
            <tr><th align="left">Total Marks</th><td colspan="3"><input type="text" id="hrSecTotal" name="hrSecTotal" readonly></td></tr>
            <tr><th align="left">Average Marks</th><td colspan="3"><input type="text" id="hrSecAverage" name="hrSecAverage" readonly></td></tr>
            <tr><th align="left">Remarks</th><td colspan="3"><input type="text" size="30" id="hrSecComments" name="hrSecComments"></td></tr>
          </table>

          <!-- Co-scholastic Evaluation Table -->
          <h3 style="margin-top:30px;">Co-scholastic Evaluation</h3>
          <table id="coScholasticTable" border="1" cellspacing="0" cellpadding="5" 
            style="width:100%; text-align:center; border-collapse:collapse; margin-top:10px;">
            <tr>
              <th>Activity</th>
              <th>Grade</th>
            </tr>
            ${["EE","Life Skills Development (LSD)","Work Experience & Art (W.E)","Physical Education (P.E)"].map((sub,i) => `
              <tr>
                <td align="left">${sub}</td>
                <td><input type="text" name="coschol_${i}" class="gradeOnly" placeholder=""></td>
              </tr>`).join('')}
          </table>
<BR>
NWD &nbsp;&nbsp;<input type="text" name="NWD" SIZE=3> &nbsp;&nbsp;Attendence &nbsp;&nbsp;<input type="text" name="attendance" SIZE=3><BR>
<BR>
Result <select name="result">
<option value=""></option>
<option value="Promoted">Promoted</option>
<option value="Fail">Fail</option>
<option value="Pass">Pass</option>
<option value="Needs Improvement">Needs Improvement</option>
<option value="Passed under Consideration">Passed under Consideration</option>
<option value="Passed with TC">Passed with TC</option>
</select>


          ${signatureHTML()}
          ${buttonsHTML()}
        </form>`;
    }

    function PhaseIILayout() {
      return `
        ${headerHTML()}
        <form id="PhaseIIForm">
          <label for="studentName">Name</label>
          <input type="text" id="studentName" name="studentName" placeholder="Student Name" required />

          <label for="studentClass">Class</label>
          <select id="studentClass" name="studentClass" required>
            <option value="">Class</option>
            <option>VIII</option>
            <option>IX</option>
          </select>

          <label for="studentSec">Section</label>
          <select id="studentSec" name="studentSec" required>
            <option value="">Sec</option>
            <option>A</option>
            <option>B</option>
            <option>C</option>
            <option>D</option>
          </select>

          <label for="rollNo">RollNo</label>
          <select id="rollNo" name="rollNo" required></select>

          <table id="phaseIITable" border="1" cellspacing="0" cellpadding="5" style="width:100%; text-align:center; border-collapse:collapse; margin-top:20px;">
            <tr>
              <th>Subject</th>
              <th>Total Marks</th>
            </tr>
            ${['English','Alt/Tenyidie/Hindi','Social Science','Science','Maths','FIT/EE/BK/GRAMMAR'].map((s,i) => `
              <tr><td align="left">${s}</td><td><input type="number" name="phase2_${i}" class="phase2Mark" min="0" max="100"></td></tr>
            `).join('')}
          </table>
<br><br>
          Remarks/Performance <label for="comments"></label><br>
          <textarea id="comments" name="comments" placeholder="Enter comments here..." rows="3" style="width:100%;"></textarea><br>


<BR><BR>

          ${signatureHTML()}
          ${buttonsHTML()}
        </form>`;
    }

    // ===================== CALC WIRING =====================
    function initWeeklyTest() {
      const inputs = document.querySelectorAll('.weeklyMark');
      const totalEl = document.getElementById('weeklyTotal');
      const avgEl = document.getElementById('weeklyAverage');
      function recalc() {
        let total = 0; let count = 0;
        inputs.forEach(inp => { const v = inp.value.trim(); if (v !== '') { const n = parseFloat(v); if (!isNaN(n)) { total += n; count++; } } });
        if (totalEl) totalEl.value = total;
        if (avgEl) avgEl.value = count > 0 ? (total / count).toFixed(2) : '';
      }
      inputs.forEach(inp => inp.addEventListener('input', recalc));
      recalc();
    }

    function initHrSec() {
      const extInputs = document.querySelectorAll('.hrExt');
      const intInputs = document.querySelectorAll('.hrInt');
      const totalInputs = document.querySelectorAll('.hrTotal');
      const totalEl = document.getElementById('hrSecTotal');
      const avgEl = document.getElementById('hrSecAverage');

      function recalc() {
        let grandTotal = 0, subjectCount = 0;
        extInputs.forEach((ext, i) => {
          const int = intInputs[i];
          const tot = totalInputs[i];
          const extVal = parseInt(ext.value) || 0;
          const intVal = parseInt(int.value) || 0;
          const hasAny = (ext.value !== "" || int.value !== "");
          const sum = hasAny ? (extVal + intVal) : "";
          tot.value = sum;
          if (hasAny) {
            grandTotal += extVal + intVal;
            subjectCount++;
          }
        });
        if (totalEl) totalEl.value = grandTotal;
        if (avgEl) avgEl.value = subjectCount > 0 ? (grandTotal / subjectCount).toFixed(2) : '';
      }

      extInputs.forEach(inp => inp.addEventListener('input', recalc));
      intInputs.forEach(inp => inp.addEventListener('input', recalc));
      recalc();
    }

    // ===================== COMMON LAYOUT SUBJECT WIRING =====================
    function initSubjects() {
      const subjects = ["English", "Grammar", "Mathematics", "Science", "SocialScience", "Hindi", "MoralValues", "Heritage", "GK", "Art", "Spelling", "Computer"];
      const subjectFieldsContainer = document.getElementById("subjectFields");
      if (!subjectFieldsContainer) return;
      subjectFieldsContainer.innerHTML = "";
      subjects.forEach((subject, idx) => {
        subjectFieldsContainer.innerHTML += `
          <label>${subject}</label>
          <input type="number" name="${subject}_ext" placeholder="EXT" min="0" max="100" oninput="calculateSubjectTotal()">
          <input type="number" name="${subject}_int" placeholder="INT" min="0" max="100" oninput="calculateSubjectTotal()">
          <input type="number" name="${subject}_total" placeholder="Total" readonly>
          <input type="text" name="${subject}_grade" placeholder="Grade" readonly>
        `;
        if (subject === "Computer") subjectFieldsContainer.innerHTML += '<br/>';
      });
    }

    function calculateSubjectTotal() {
      const inputs = Array.from(document.querySelectorAll('#subjectFields input'));
      for (let i = 0; i < inputs.length; i += 4) {
        const extValue = inputs[i].value;
        const intValue = inputs[i + 1].value;
        const ext = parseInt(extValue);
        const int = parseInt(intValue);
        if (extValue === "" && intValue === "") {
          inputs[i + 2].value = "";
          inputs[i + 3].value = "";
        } else {
          const total = (isNaN(ext) ? 0 : ext) + (isNaN(int) ? 0 : int);
          inputs[i + 2].value = total;
          inputs[i + 3].value = getGrade(total);
        }
      }
      calculateOverallTotalAndAverage();
    }

    function getGrade(score) {
      if (score >= 90) return "A**";
      if (score >= 80) return "A*";
      if (score >= 70) return "B1";
      if (score >= 60) return "B2";
      if (score >= 50) return "C1";
      if (score >= 40) return "C2";
      return "D";
    }

    function calculateOverallTotalAndAverage() {
      const allTotals = document.querySelectorAll('#subjectFields input[placeholder="Total"]');
      let sum = 0; let count = 0;
      allTotals.forEach(input => { const val = parseInt(input.value); if (!isNaN(val)) { sum += val; count++; } });
      const totalEl = document.getElementById('overallTotal');
      const avgEl = document.getElementById('averageMarks');
      if (totalEl) totalEl.value = sum;
      if (avgEl) avgEl.value = count > 0 ? (sum / count).toFixed(2) : '';
    }

    // ===================== EXPORT =====================
    function downloadAsImage() {
      const container = document.querySelector('.container');
      html2canvas(container, { useCORS: true, scale: 2 }).then(canvas => {
        canvas.toBlob(function(blob) {
          const link = document.createElement('a');
          const studentName = document.getElementById('studentName')?.value || 'marksheet';
          const studentClass = document.getElementById('studentClass')?.value || '';
          const fileName = `${studentName}_Class${studentClass}.jpg`;

          if (window.navigator && window.navigator.msSaveOrOpenBlob) {
            window.navigator.msSaveOrOpenBlob(blob, fileName);
          } else {
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          }
        }, 'image/jpeg', 1.0);
      }).catch(err => console.error('html2canvas error', err));
    }

    // ===================== ROLL NOS =====================
    function initRollNos() {
      const rollNoSelect = document.getElementById("rollNo");
      if (!rollNoSelect) return;
      rollNoSelect.innerHTML = '';
      for (let i = 1; i <= 90; i++) {
        const option = document.createElement("option");
        option.value = i; option.textContent = i; rollNoSelect.appendChild(option);
      }
    }

    // ===================== EXAM TEXTBOX WIRING =====================
    function updateExamTextDisplays() {
      const select = document.getElementById('examType');
      if (!select) return;
      const text = select.options[select.selectedIndex]?.text || '';
      document.querySelectorAll('.examNameDisplay').forEach(el => { el.value = text; });
    }

    function wireExamHandlers() {
      const select = document.getElementById('examType');
      if (!select) return;
      // remove previous handler if any
      select.onchange = null;
      select.addEventListener('change', () => {
        handleExamTypeChange();
      });
    }

    // ===================== SAVE / EXPORT JSON =====================
    function saveData() {
      const form = document.querySelector("form");
      if (!form) return;

      const formData = {};
      new FormData(form).forEach((value, key) => {
        if (formData[key]) {
          if (!Array.isArray(formData[key])) formData[key] = [formData[key]];
          formData[key].push(value);
        } else {
          formData[key] = value;
        }
      });

      const jsonData = JSON.stringify(formData, null, 2);
      const blob = new Blob([jsonData], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');

      const studentName = document.getElementById('studentName')?.value || 'marksheet';
      const studentClass = document.getElementById('studentClass')?.value || '';
      link.download = `${studentName}_Class${studentClass}.json`;

      link.href = url;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // ===================== SELF TESTS =====================
    (function selfTests(){
      try {
        console.assert(typeof authenticate === 'function', 'authenticate should be defined');
        console.assert(typeof getCommonLayout === 'function', 'getCommonLayout should be defined');
        console.assert(typeof getWeeklyTestLayout === 'function', 'getWeeklyTestLayout should be defined');
        console.assert(typeof getHrSecLayout === 'function', 'getHrSecLayout should be defined');
        console.assert(typeof handleExamTypeChange === 'function', 'handleExamTypeChange should be defined');
        document.getElementById('mainContent').innerHTML = getCommonLayout();
        initSubjects(); initRollNos();
        const rn = document.getElementById('rollNo');
        console.assert(rn && rn.options.length === 90, 'RollNo should have 90 options');
        const exSel = document.getElementById('examType');
        if (exSel) {
          exSel.value = 'Weekly Test';
          updateExamTextDisplays();
          const boxVal = document.querySelector('.examNameDisplay')?.value || '';
          console.assert(boxVal === 'Weekly Test', 'Exam text box should mirror the selected exam');
        }
        console.log('[SelfTest] Core functions present and basic checks passed');
        loadMarksheet();
      } catch (e) {
        console.warn('[SelfTest] Failed:', e);
      }
    })();

function hideActionButtons() {
      document.querySelectorAll(".button-row button").forEach(btn => {
        btn.classList.add("hidden");
      });
    }

    function showActionButtons() {
      document.querySelectorAll(".button-row button").forEach(btn => {
        btn.classList.remove("hidden");
      });
    }

    // ===================== DOWNLOAD AS IMAGE =====================
    function downloadAsImage() {
      hideActionButtons(); // hide before capture

      const container = document.querySelector('.container');
      html2canvas(container, { useCORS: true, scale: 2 }).then(canvas => {
        canvas.toBlob(function(blob) {
          const link = document.createElement('a');
          const studentName = document.getElementById('studentName')?.value || 'marksheet';
          const studentClass = document.getElementById('studentClass')?.value || '';
          const fileName = `${studentName}_Class${studentClass}.jpg`;

          if (window.navigator && window.navigator.msSaveOrOpenBlob) {
            window.navigator.msSaveOrOpenBlob(blob, fileName);
          } else {
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          }

          showActionButtons(); // restore buttons
        }, 'image/jpeg', 1.0);
      }).catch(err => {
        console.error('html2canvas error', err);
        showActionButtons();
      });
    }

    // ===================== SAVE DATA =====================
    function saveData() {
      hideActionButtons();

      const form = document.querySelector("form");
      if (!form) return;

      const formData = {};
      new FormData(form).forEach((value, key) => {
        if (formData[key]) {
          if (!Array.isArray(formData[key])) formData[key] = [formData[key]];
          formData[key].push(value);
        } else {
          formData[key] = value;
        }
      });

      const jsonData = JSON.stringify(formData, null, 2);
      const blob = new Blob([jsonData], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');

      const studentName = document.getElementById('studentName')?.value || 'marksheet';
      const studentClass = document.getElementById('studentClass')?.value || '';
      link.download = `${studentName}_Class${studentClass}.json`;

      link.href = url;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      showActionButtons();
    }

    // ===================== PRINT =====================
    function printMarksheet() {
      hideActionButtons();
      window.print();
      showActionButtons();
    }
  </script>
</body>
</html>
